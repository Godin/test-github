name: sum
on:
  - workflow_dispatch
  - push
jobs:
  test-reuse:
    uses: ./.github/workflows/reuse.yml
  sum-reuse:
    needs: test-reuse
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      # https://docs.github.com/en/actions/learn-github-actions/contexts#example-printing-context-information-to-the-log
      - name: Debug
        env:
          DEBUG: ${{ toJSON(needs) }}
        run: echo "$DEBUG"

  test-success:
    runs-on: ubuntu-latest
    steps:
      - run: exit 0
  test-failure:
    if: false
    runs-on: ubuntu-latest
    steps:
      - run: exit 1
  test-skipped:
    runs-on: ubuntu-latest
    if: ${{ false }}
    steps:
      - run: echo three
  test-timeout:
    if: false
    timeout-minutes: 1
    runs-on: ubuntu-latest
    steps:
      - run: sleep 120
  test-matrix:
    if: false
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - code: 0
          - code: 1
          # sleep to test cancellation
          - code: 10
    steps:
      - run: sleep ${{ matrix.code }} && exit ${{ matrix.code }}
  sum0:
    # this job will be skipped, because needs skipped job, required check on skipped job allows merge
    needs: [test-skipped]
    runs-on: ubuntu-latest
    steps:
      - run: echo
  sum:
    needs:
      #- test-matrix
      - test-success
      - test-failure
      - test-skipped
      - test-timeout
    # https://docs.github.com/en/actions/learn-github-actions/expressions#cancelled
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      # https://docs.github.com/en/actions/learn-github-actions/contexts#example-printing-context-information-to-the-log
      - name: Debug
        env:
          DEBUG: ${{ toJSON(needs) }}
        run: echo "$DEBUG"
      # https://docs.github.com/en/actions/learn-github-actions/contexts#jobs-context
      # https://github.com/actions/runner/issues/2566#issuecomment-1522574653
      # https://emmer.dev/blog/skippable-github-status-checks-aren-t-really-required/
      # https://brunoscheufler.com/blog/2022-04-09-the-required-github-status-check-that-wasnt
      # TODO should check for 'cancelled'
      - if: ${{ contains(needs.*.result, 'skipped') || contains(needs.*.result, 'failure') }}
        run: exit 1
